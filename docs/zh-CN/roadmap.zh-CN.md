# Roadmap / 版本更迭记录

> 本文档描述项目各版本的目标与计划中的功能。  
> 当前已经实现的结构细节与行为，请参考：`docs/architecture.zh-CN.md`。  
> 设计决策与取舍记录见：`docs/decisions.zh-CN.md`。

---

## v0.5 - 基础功能（单条流程跑通）

### 目标

- 从「输入一个成品名称/关键词」到「看到完整材料树」，打通**一条完整数据流**。
- 确定各层职责边界：  
  - Vue 组件：展示 & 交互；  
  - Store / core：状态管理 & 纯计算。
- 暂不追求复杂搜索体验优化，重点是：**能用、算对、结构清晰，方便后续扩展**。

---

### 流程总览

1. 用户在 `SearchBar.vue` 输入成品名称/关键词。
2. 根据输入，生成候选成品列表并展示（成品列表 / 目标成品面板）。
3. 用户选择成品 + 编辑数量，得到统一格式的「成品清单」。
4. `core.js / calcMaterials.js` 接收成品清单 + 数据表（`items` / `recipes`），计算出材料结果。
5. 材料树逻辑 JS（如 `useMaterialTree.js`）将材料结果 + 用户设置组合成最终的树形结构。
6. `MaterialTree.vue` 渲染材料树。

---

### 模块拆分与职责

#### 1. 搜索框 / `SearchBar.vue`

**v1.0 主要职责：**

- 提供一个可用的搜索输入框，暴露 `query` 变化（`emit("update:query", value)` 或类似事件）。
- 不负责业务决策，只做「输入体验」相关的基础处理：

  - 去掉明显无效字符（如 `\n`、制表符）。
  - （可选）合并连续空格。
  - （可选）防抖。
  - （可选）在中文输入法 composition 期间不触发更新。

> 这些逻辑都属于「输入框怎么表现」的层面。  
> v1.0 可以只实现最小可用版本，剩下的体验优化可以在后续版本迭代。

---

#### 2. 成品列表 / 目标成品面板

可以是 `TargetItemPanel.vue`（或其他命名，本 roadmap 只描述职责）：

- 接收：  
  - 搜索结果（候选成品数组）；  
  - 当前已选成品及其数量。
- 提供能力：
  - 点击/选择一个成品；
  - 编辑数量（加减、输入数值等）。
- 输出统一结构的「成品清单」，供 core 使用，例如：

```ts
type TargetItem = {
  itemId: number;
  quantity: number;
};

type TargetItemList = TargetItem[];
```

---

#### 3. 核心计算 / `core.js` 或 `calcMaterials.js`

**职责：**

- **纯函数**，只做计算，不依赖 Vue 或组件实例。
- 输入：
  - 成品清单（`TargetItemList`）；
  - `items` / `recipes` 数据；
  - 计算选项（比如：是否合并相同材料、是否展开子配方、深度限制等）。
- 输出：
  - 扁平材料汇总（for 总表展示）；  
  - 或包含层级信息的中间结构，供材料树使用。

**示例接口：**

```js
// 不碰 Vue / store，只根据入参算结果
export function calcMaterials(targetItems, items, recipes, options) {
  // 返回 { flatMaterials, materialTree } 等结构
}
```

> 这里也包括「如何解释 query」这类业务规则：大小写是否忽略、别名/多语言匹配、模糊匹配等——  
> 这些都属于「结果正确性」的一部分，要集中在业务/计算层统一处理。

---

#### 4. 材料树逻辑 JS（例如 `useMaterialTree.js`）

**职责：**

- 接收 `calcMaterials` 的输出。
- 结合用户在各个小组件中的展示设置（折叠/展开规则、排序方式、是否按类别分组等）。
- 输出适合 `MaterialTree.vue` 渲染的结构，例如：

```ts
type MaterialTreeNode = {
  id: number;
  name: string;
  quantity: number;
  children: MaterialTreeNode[];
};
```

> 如果需要暂存展示设置，推荐通过单独的设置 store / composable  
> （如：`useCalculatorSettings()`）来读写，而不是塞在某个组件内部。

---

#### 5. 搜索状态与清洗策略（Store 层）

为了兼容未来多种 query 入口（搜索框、最近搜索、URL 参数、快捷键等），采用**双层清洗**：

1. **UI 层：`SearchBar.vue`**
   - 负责「输入体验」相关的清洗：去掉 `\n`、合并空白、防抖、composition 处理等。
   - 目的是让输入框「好用、不卡、不恶心人」。

2. **Store 层：`setSearchQuery()`（最终闸门）**
   - 接收所有入口写进来的原始 query（包括 SearchBar / 最近搜索 / URL 等）。
   - 在这里做「最终统一规则」，例如：
     - `.trim()` 去掉首尾空白；
     - 限制最大长度；
     - 必要时做 normalize（全角半角、大小写、特殊字符等）。

**示例：**

```js
function setSearchQuery(raw) {
  const cleaned = raw.trim().slice(0, MAX_QUERY_LENGTH);
  state.query = cleaned;
}
```

3. **核心计算：`calcMaterials(query, items, recipes, options)`**
   - 假定传入的 `query` 已经过 store 的最终清洗。
   - 专注于「解释 query + 计算结果」，不再加入额外的清洗逻辑。

> 这个结构保证：  
> - UI 可以灵活调整体验；  
> - 业务层规则不会被绕开；  
> - 同一个 query，从任何入口进入，得到的结果一致。

---

### v1.0 验收标准（建议）

- 能完成以下操作，并得到合理稳定的结果：

  1. 在 `SearchBar` 输入一个成品名称/关键词；
  2. 在成品列表中选中该成品，编辑数量；
  3. 页面展示出该成品的材料树，数量正确；
  4. 调整成品数量，材料树实时更新；
  5. 刷新页面后，基础流程仍可复现（不依赖某个临时状态）。

- 核心计算函数可以在单元测试里**单独调用**，不需要挂载 Vue 组件即可验证逻辑。


--------------
等下，我们先不说具体代码的事情，我们先来理一下需求，再规划一下要怎么分步实现/哪些只挂在那当个饼：
目前想到的所有需求是：
可以拆的材料置顶显示，不过还是水晶分开展示，只是材料那一栏内部置顶；
同时第一层的材料底色是最重的，越展开背景颜色越淡，用这个来提醒用户这是第几层的材料；
同时像你刚才提的，有拆分按钮的同时也有合并按钮，材料拆分之后就生成一个独立的小卡片，把那一种材料拆开生成的所有子材料都囊括在里面（除了水晶，这个直接在上面的水晶栏加减计算），合并按钮就在卡片上。
与此同时我还想加入一些快捷键，比如直接展开到最底层材料，不显示水晶，一键把已展开的材料合并。还有展示已经计算出来的材料的获取方式（以icon的形式）。还会想让这个工具站兼容多语言。
然后还有更大一点的设想，这些都是部署之后的打算了：本地储存用户查询历史，点击材料名跳转对应的wiki链接(这个太难了因为还要考虑国际服wiki和国服不是同一个。退而求其次可以先只给一个点击复制材料名),还有预设套装。还有按获取方式在材料列表里排序，比如选【可制作的优先放在最前面】，【点数兑换的优先放在最前面】，【按职业排序】但是这个套装和点数展示已经有别的工具站做了，而且做得还挺好用的，我在想是不是没必要加重复功能了，没必要。
在配方重复时显示提示，让用户可以切换到底选用哪种配方（只拎出来不一样的）
做1个出3个的时候也在成品列表显示提示。如果用户输入的数字不是3的倍数，提示会有多余x个。
暂时就想到这些

override要抽一个接口出来手动，然后计算递归也要抽接口手动，我草那要展示recipe的话要么手动写一个查询函数要么就把映射O(1)那个材料列表也抽出来

提示当前可能会产出多余的。

---------------------
## v1.0 - MVP(部署上线版本)
搜索栏：保持现状可以，顶多加一点已经有现成库的搜索优化，比如模糊匹配之类的 
成品列表：标注选用配方的制作职业，暂时不考虑切换一个物品的多个配方，直接选默认的。剩下的和现在已经做好的一样 
材料列表：作为一个整体，内部分为可制作材料和不可制作材料，不可制作材料显示获取来源，可制作材料显示制作职业。整体做成checklist的形式，同时用锁链和ui深浅变化表示该材料是否被拆分。如已被拆分，则把右边个数显示成需制作次数。checklist前面的方框被勾选后，整个材料这一栏被紫色蒙版覆盖，附加check字样。以上操作均可逆 
其他小部件：快捷键，一键拆到底+一键折叠到最上层可制作材料。一键清空targets和伴生信息（应该只要清除target列表就行了？倾向于数据结构做成由这个发散出来的）顶端显示魔石精计算器 ｜ FFXIV制作材料计算器 靠左，向右用其他语言浅色字体显示moshijing 英端翻译 日端翻译及其他seo信息 

制约：先不求好看，只求功能都实现+gpt可以写不用我自己写；显示玩家库存这个功能留下接口但是不要先写，数据结构设计成兼容的形式给未来拓展留位置，要写直接调用就行
